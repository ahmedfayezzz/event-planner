// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  GUEST
  ADMIN
  SUPER_ADMIN
}

enum VisibilityStatus {
  inactive
  active
  archived
}

model User {
  id            String    @id @default(cuid())
  name          String
  username      String    @unique
  email         String    @unique
  phone         String    @unique
  passwordHash  String?

  // Social media
  instagram     String?
  snapchat      String?
  twitter       String?

  // Professional info
  companyName   String?
  position      String?
  activityType  String?
  gender        String?
  goal          String?
  aiDescription String?

  // Status
  isApproved    Boolean   @default(true)
  isActive      Boolean   @default(true)
  role          Role      @default(USER)

  // Admin permissions (only relevant if role is ADMIN)
  canAccessDashboard  Boolean  @default(false)
  canAccessSessions   Boolean  @default(false)
  canAccessUsers      Boolean  @default(false)
  canAccessHosts      Boolean  @default(false)
  canAccessAnalytics  Boolean  @default(false)
  canAccessCheckin    Boolean  @default(false)
  canAccessSettings   Boolean  @default(false)
  canAccessSuggestions Boolean @default(false)
  canAccessEmailCampaigns Boolean @default(false)

  // Password reset
  resetToken        String?
  resetTokenExpires DateTime?

  // Remember me / refresh token
  refreshToken        String?
  refreshTokenExpires DateTime?

  // Hosting preferences
  wantsToHost      Boolean   @default(false)
  hostingTypes     String[]  @default([])

  // Manual creation tracking
  isManuallyCreated  Boolean   @default(false)  // true if created via manual registration
  createdByAdminId   String?                    // Admin who created the user

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Profile image
  avatarUrl     String?

  // Relations
  registrations Registration[]
  eventCaterings EventCatering[]
  labels UserLabel[]
  notes         UserNote[] @relation("UserNotes")
  notesCreated  UserNote[] @relation("NotesCreated")
  sponsors      Sponsor[]
  sponsorNotesCreated SponsorNote[] @relation("SponsorNoteAuthor")
  suggestions   Suggestion[]
  emailDrafts   EmailDraft[]    @relation("DraftCreator")
  emailTemplates EmailTemplate[] @relation("TemplateCreator")
  emailCampaignsCreated  EmailCampaign[]          @relation("CampaignCreator")
  emailCampaignsReceived EmailCampaignRecipient[] @relation("RecipientUser")
  approvedRegistrations Registration[] @relation("RegistrationApprovedBy")
}

model Session {
  id              String   @id @default(cuid())
  sessionNumber   Int      @unique
  title           String
  description     String?
  date            DateTime

  // Capacity
  maxParticipants Int      @default(50)
  maxCompanions   Int      @default(5)

  // Status
  status          String   @default("open") // open, closed, completed
  visibilityStatus VisibilityStatus @default(inactive) // inactive, active, archived

  // Settings
  requiresApproval      Boolean  @default(false)
  showParticipantCount  Boolean  @default(true)
  location              String?

  // Advanced Settings
  registrationDeadline  DateTime?
  showCountdown         Boolean  @default(true)
  showGuestProfile      Boolean  @default(true)
  enableMiniView        Boolean  @default(false)
  customConfirmationMessage String?
  embedEnabled          Boolean  @default(true)
  slug                  String?  @unique
  inviteOnly            Boolean  @default(false)
  inviteMessage         String?
  sendQrInEmail         Boolean  @default(true)
  showSocialMediaFields Boolean  @default(true)
  showRegistrationPurpose Boolean  @default(true)
  showCateringInterest  Boolean  @default(true)
  locationUrl           String?

  // Banner image
  bannerUrl             String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  registrations     Registration[]
  attendances       Attendance[]
  invites           Invite[]
  eventCaterings    EventCatering[]
  eventSponsorships EventSponsorship[]
  sessionGuests     SessionGuest[]
}

model Registration {
  id          String   @id @default(cuid())
  userId      String?
  sessionId   String
  registeredAt DateTime @default(now())
  isApproved  Boolean  @default(true)
  isRejected      Boolean  @default(false)
  rejectionReason String?
  approvalNotes   String?
  approvedById    String?
  approvedBy      User?    @relation("RegistrationApprovedBy", fields: [approvedById], references: [id])

  // Guest registration fields (used when userId is NULL)
  guestName         String?
  guestEmail        String?
  guestPhone        String?
  guestInstagram    String?
  guestSnapchat     String?
  guestTwitter      String?
  guestCompanyName  String?
  guestPosition     String?
  guestActivityType String?
  guestGender       String?
  guestGoal         String?

  // Guest hosting preferences (DEPRECATED - use sponsor fields below)
  guestWantsToHost    Boolean   @default(false)
  guestHostingTypes   String[]  @default([])

  // NEW: Sponsor interest fields (for both guests and members)
  wantsToSponsor        Boolean   @default(false)
  sponsorshipTypes      String[]  @default([])
  sponsorshipOtherText  String?
  sponsorType           String?   // "person" | "company"

  // Manual registration tracking
  isManual       Boolean   @default(false)  // true if created via manual registration
  manualAddedBy  String?                    // Admin user ID who added it manually
  manualAddedAt  DateTime?                  // When it was manually added

  // Companion/Invited relationship (self-referential)
  invitedByRegistrationId  String?
  invitedByRegistration    Registration?  @relation("InvitedBy", fields: [invitedByRegistrationId], references: [id])
  invitedRegistrations     Registration[] @relation("InvitedBy")

  // Relations
  user        User?       @relation(fields: [userId], references: [id])
  session     Session     @relation(fields: [sessionId], references: [id])
  attendance  Attendance?

  @@unique([userId, sessionId])
}

model Attendance {
  id             String   @id @default(cuid())
  registrationId String   @unique
  sessionId      String
  attended       Boolean  @default(false)
  checkInTime    DateTime?
  qrVerified     Boolean  @default(false)

  // Relations
  registration   Registration @relation(fields: [registrationId], references: [id])
  session        Session      @relation(fields: [sessionId], references: [id])

  @@unique([registrationId, sessionId])
}

model Invite {
  id            String    @id @default(cuid())
  sessionId     String
  email         String
  token         String    @unique
  used          Boolean   @default(false)
  invalidated   Boolean   @default(false)
  invalidatedAt DateTime?
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  sentAt        DateTime?

  // Relations
  session     Session  @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}

// DEPRECATED - kept for migration, use EventSponsorship instead
model EventCatering {
  id             String   @id @default(cuid())
  sessionId      String
  hostId         String?
  hostingType    String   // dinner, beverage, dessert, other
  isSelfCatering Boolean  @default(false)
  notes          String?

  // Sponsor/host logo
  logoUrl        String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  host    User?   @relation(fields: [hostId], references: [id])

  @@index([sessionId])
}

// NEW: Sponsor entity - can be linked to a User or standalone
model Sponsor {
  id                   String    @id @default(cuid())
  name                 String
  email                String?
  phone                String?
  type                 String    @default("person") // "person" | "company"
  status               String    @default("new") // new, contacted, sponsored, interested_again, interested_permanent
  logoUrl              String?
  logoBackground       String    @default("transparent") // transparent, dark, light, primary
  sponsorshipTypes     String[]  @default([])
  sponsorshipOtherText String?
  socialMediaLinks     Json?     // { "twitter": "url", "linkedin": "url", ... }

  // Optional link to user (member who wants to sponsor) - multiple sponsors can link to one user
  userId               String?
  user                 User?     @relation(fields: [userId], references: [id])

  isActive             Boolean   @default(true)
  isArchived           Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  eventSponsorships    EventSponsorship[]
  notes                SponsorNote[]
  labels               SponsorLabel[] @relation("SponsorToLabel")
  sponsorAttachments   SponsorAttachment[]

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([isArchived])
}

// NEW: Links sponsors to events (replaces EventCatering)
model EventSponsorship {
  id              String    @id @default(cuid())
  sessionId       String
  sponsorId       String?
  sponsorshipType String    // dinner, beverage, dessert, other
  isSelfSponsored Boolean   @default(false)
  notes           String?
  displayOrder    Int       @default(0)  // Lower = higher priority (displayed first/right in RTL)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sponsor         Sponsor?  @relation(fields: [sponsorId], references: [id])

  @@index([sessionId])
  @@index([sponsorId])
}

// Guest entity - event speakers/guests with reusable profiles
model Guest {
  id               String    @id @default(cuid())
  title            String?   // "Dr.", "Eng.", "Prof." or custom
  name             String
  jobTitle         String?
  company          String?
  description      String?   @db.Text
  imageUrl         String?
  socialMediaLinks Json?     // { "twitter": "url", "linkedin": "url", ... }

  isPublic         Boolean   @default(false)  // Admin controls public visibility
  isActive         Boolean   @default(true)   // Soft delete

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  sessionGuests    SessionGuest[]

  @@index([isActive])
  @@index([isPublic])
  @@index([name])
}

// Join table for many-to-many Session <-> Guest relationship
model SessionGuest {
  id           String   @id @default(cuid())
  sessionId    String
  guestId      String
  displayOrder Int      @default(0)  // For ordering multiple guests

  createdAt    DateTime @default(now())

  // Relations
  session      Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  guest        Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([sessionId, guestId])
  @@index([sessionId])
  @@index([guestId])
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique // singleton key "global"

  // Registration form field visibility defaults
  showSocialMediaFields   Boolean  @default(true)
  showRegistrationPurpose Boolean  @default(true)
  showCateringInterest    Boolean  @default(true)

  // System settings
  siteName        String?
  contactEmail    String?
  contactPhone    String?

  // Social media handles (organization's social media)
  twitterHandle   String?
  instagramHandle String?
  snapchatHandle  String?
  linkedinUrl     String?
  whatsappNumber  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserLabel {
  id    String @id @default(cuid())
  name  String @unique
  color String @default("#3b82f6") // Default blue color

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]

  @@index([name])
}

model UserNote {
  id        String   @id @default(cuid())
  content   String

  // User this note is about
  userId    String
  user      User     @relation("UserNotes", fields: [userId], references: [id], onDelete: Cascade)

  // Admin who created the note
  createdById String
  createdBy   User   @relation("NotesCreated", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdById])
}

model SponsorNote {
  id        String   @id @default(cuid())
  content   String

  // Sponsor this note is about
  sponsorId String
  sponsor   Sponsor  @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  // Admin who created the note
  createdById String
  createdBy   User   @relation("SponsorNoteAuthor", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sponsorId])
  @@index([createdById])
}

model SponsorLabel {
  id        String    @id @default(cuid())
  name      String    @unique
  color     String    @default("#6366f1")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  sponsors  Sponsor[] @relation("SponsorToLabel")

  @@index([name])
}

// Attachment entity - can be linked to various entities via pivot tables
model Attachment {
  id          String   @id @default(cuid())
  filename    String
  url         String
  contentType String
  size        Int
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  // Pivot relations
  sponsors    SponsorAttachment[]
  // Future: users UserAttachment[]
  // Future: sessions SessionAttachment[]
}

// Pivot table linking Attachments to Sponsors
model SponsorAttachment {
  id           String     @id @default(cuid())
  sponsorId    String
  attachmentId String
  createdAt    DateTime   @default(now())

  sponsor      Sponsor    @relation(fields: [sponsorId], references: [id], onDelete: Cascade)
  attachment   Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)

  @@unique([sponsorId, attachmentId])
  @@index([sponsorId])
  @@index([attachmentId])
}

model EmailLog {
  id           String    @id @default(cuid())
  to           String
  subject      String
  type         String    // "confirmed", "pending", "companion", "welcome", "bulk", etc.
  status       String    @default("pending") // "pending", "sent", "failed"
  errorMessage String?
  attempts     Int       @default(0)

  // Optional references for context
  registrationId String?
  sessionId      String?

  createdAt DateTime  @default(now())
  sentAt    DateTime?

  @@index([status])
  @@index([registrationId])
  @@index([createdAt])
}

// Email drafts for bulk emails (in-progress compositions)
model EmailDraft {
  id          String   @id @default(cuid())
  name        String
  subject     String?
  content     String?
  filters     Json?    // Saved filter state for user selection

  createdById String
  createdBy   User     @relation("DraftCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
}

// Reusable email templates
// type: "custom" for admin-created, future: "confirmation", "invitation", etc.
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String   @default("custom")  // "custom" | future: "confirmation", "invitation", etc.
  subject     String
  content     String
  isSystem    Boolean  @default(false)     // true for system templates (non-deletable)

  createdById String?
  createdBy   User?    @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([createdById])
}

// Email campaign for bulk emails - groups sent emails together
model EmailCampaign {
  id               String   @id @default(cuid())
  name             String?
  subject          String
  content          String   @db.Text  // Full HTML content for history

  totalRecipients  Int      @default(0)
  sentCount        Int      @default(0)
  failedCount      Int      @default(0)

  status           String   @default("draft") // draft, sending, completed, failed
  recipientFilters Json?    // Saved filters for reference
  attachments      Json?    // Array of {filename, content}

  createdById      String
  createdBy        User     @relation("CampaignCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  sentAt           DateTime?
  completedAt      DateTime?

  recipients       EmailCampaignRecipient[]

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
}

// Individual recipient in a campaign
model EmailCampaignRecipient {
  id           String   @id @default(cuid())
  campaignId   String
  userId       String?
  email        String
  name         String?

  status       String   @default("pending") // pending, sent, failed
  errorMessage String?
  sentAt       DateTime?

  campaign     EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user         User?         @relation("RecipientUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([userId])
  @@index([status])
}

model Suggestion {
  id        String   @id @default(cuid())
  content   String   @db.Text
  status    String   @default("pending") // pending, reviewed, implemented, dismissed

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
