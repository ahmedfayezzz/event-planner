// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String
  username      String    @unique
  email         String    @unique
  phone         String    @unique
  passwordHash  String?

  // Social media
  instagram     String?
  snapchat      String?
  twitter       String?

  // Professional info
  companyName   String?
  position      String?
  activityType  String?
  gender        String?
  goal          String?
  aiDescription String?

  // Status
  isApproved    Boolean   @default(true)
  isActive      Boolean   @default(true)
  role          Role      @default(USER)

  // Admin permissions (only relevant if role is ADMIN)
  canAccessDashboard  Boolean  @default(false)
  canAccessSessions   Boolean  @default(false)
  canAccessUsers      Boolean  @default(false)
  canAccessHosts      Boolean  @default(false)
  canAccessAnalytics  Boolean  @default(false)
  canAccessCheckin    Boolean  @default(false)
  canAccessSettings   Boolean  @default(false)

  // Password reset
  resetToken        String?
  resetTokenExpires DateTime?

  // Remember me / refresh token
  refreshToken        String?
  refreshTokenExpires DateTime?

  // Hosting preferences
  wantsToHost      Boolean   @default(false)
  hostingTypes     String[]  @default([])

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  registrations Registration[]
  eventCaterings EventCatering[]
  labels UserLabel[]
}

model Session {
  id              String   @id @default(cuid())
  sessionNumber   Int      @unique
  title           String
  description     String?
  date            DateTime

  // Guest info
  guestName       String?
  guestProfile    String?

  // Capacity
  maxParticipants Int      @default(50)
  maxCompanions   Int      @default(5)

  // Status
  status          String   @default("open") // open, closed, completed

  // Settings
  requiresApproval      Boolean  @default(false)
  showParticipantCount  Boolean  @default(true)
  location              String?

  // Advanced Settings
  registrationDeadline  DateTime?
  showCountdown         Boolean  @default(true)
  showGuestProfile      Boolean  @default(true)
  enableMiniView        Boolean  @default(false)
  customConfirmationMessage String?
  embedEnabled          Boolean  @default(true)
  slug                  String?  @unique
  inviteOnly            Boolean  @default(false)
  inviteMessage         String?
  sendQrInEmail         Boolean  @default(true)
  showSocialMediaFields Boolean  @default(true)
  showRegistrationPurpose Boolean  @default(true)
  showCateringInterest  Boolean  @default(true)
  locationUrl           String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  registrations  Registration[]
  attendances    Attendance[]
  invites        Invite[]
  eventCaterings EventCatering[]
}

model Registration {
  id          String   @id @default(cuid())
  userId      String?
  sessionId   String
  registeredAt DateTime @default(now())
  isApproved  Boolean  @default(true)
  approvalNotes String?

  // Guest registration fields (used when userId is NULL)
  guestName         String?
  guestEmail        String?
  guestPhone        String?
  guestInstagram    String?
  guestSnapchat     String?
  guestTwitter      String?
  guestCompanyName  String?
  guestPosition     String?
  guestActivityType String?
  guestGender       String?
  guestGoal         String?

  // Guest hosting preferences
  guestWantsToHost    Boolean   @default(false)
  guestHostingTypes   String[]  @default([])

  // Companion/Invited relationship (self-referential)
  invitedByRegistrationId  String?
  invitedByRegistration    Registration?  @relation("InvitedBy", fields: [invitedByRegistrationId], references: [id])
  invitedRegistrations     Registration[] @relation("InvitedBy")

  // Relations
  user        User?       @relation(fields: [userId], references: [id])
  session     Session     @relation(fields: [sessionId], references: [id])
  attendance  Attendance?

  @@unique([userId, sessionId])
}

model Attendance {
  id             String   @id @default(cuid())
  registrationId String   @unique
  sessionId      String
  attended       Boolean  @default(false)
  checkInTime    DateTime?
  qrVerified     Boolean  @default(false)

  // Relations
  registration   Registration @relation(fields: [registrationId], references: [id])
  session        Session      @relation(fields: [sessionId], references: [id])

  @@unique([registrationId, sessionId])
}

model Invite {
  id            String    @id @default(cuid())
  sessionId     String
  email         String
  token         String    @unique
  used          Boolean   @default(false)
  invalidated   Boolean   @default(false)
  invalidatedAt DateTime?
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  sentAt        DateTime?

  // Relations
  session     Session  @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
}

model EventCatering {
  id             String   @id @default(cuid())
  sessionId      String
  hostId         String?
  hostingType    String   // dinner, beverage, dessert, other
  isSelfCatering Boolean  @default(false)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  host    User?   @relation(fields: [hostId], references: [id])

  @@index([sessionId])
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique // singleton key "global"

  // Registration form field visibility defaults
  showSocialMediaFields   Boolean  @default(true)
  showRegistrationPurpose Boolean  @default(true)
  showCateringInterest    Boolean  @default(true)

  // System settings
  siteName        String?
  contactEmail    String?
  contactPhone    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserLabel {
  id    String @id @default(cuid())
  name  String @unique
  color String @default("#3b82f6") // Default blue color

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]

  @@index([name])
}
